1. Combine color and height buffers and split using masks during iter
2. Look into ideas from the c++ code